+++

date = 2021-10-06T17:05:00+08:00
title = "查询一条mysql都经历了什么"
url = "/internet/depth/mysql_query"

draft = true

+++



在客户端执行一条mysql查询命令，到客户端接收到查询结果，这中间mysql服务器都做了哪些事情呢？

先来了解下mysql体系架构。

## mysql体系架构

![](https://raw.githubusercontent.com/stong1994/images/master/picgo/20211006171205.jfif)

*图片来自: https://segmentfault.com/a/1190000039693313*

以上图为对照，mysql的查询会经历大致以下过程：

1. 客户端与服务端建立连接
2. 查询缓存
3. 将请求的SQL进行解析，并进行语法校验
4. 通过优化器来优化SQL，生成执行计划
5. 选择对应的存储引擎来执行计划，获取数据
6. 向客户端返回查询结果

那么我们就来分别看看这几步都做了哪些事情。

## 建立连接

客户端与服务端的连接本质上是进程间的通信，进程之间的通信方式有：管道、命名管道、命名字、TCP/IP套接字、UNIX域套接字。我们只讨论最常见的TCP/IP套接字。

```bash
mysql -h 127.0.0.1 -u root -p
```

连接时会查询`mysql.user`表进行权限校验。

> MySQL的通信协议是半双工的——在任意时刻，要么客户端向服务端发送数据，要么服务端向客户端发送数据。

## 查询缓存

如果操作为查询，并且mysql服务器开启了查询缓存，那么MySQL服务器会对sql进行缓存命中。

这个缓存是由大小写敏感的哈希查找实现的，对sql的任何改动都会导致不能命中缓存。

## 解析sql

在这一步会校验sql是否符合语法，并将sql解析为token。

## 查询优化

MySQL使用基于成本的优化器。成本分为IO成本和CPU成本，MySQL会定义每种操作对应的代价。大致流程为：

1. 根据搜索条件，找出所有可能使用的索引
2. 计算全表扫描的代价
3. 计算使用不同索引执行查询的代价
4. 对比各种方案，选择成本最低的那个

## 执行计划

对不同的存储引擎，其执行计划的实现都不同。我们只讨论Innodb。



