+++

date = 2022-03-25T15:58:00+08:00
title = "在浏览器访问一个网址都经历了哪些"
url = "/internet/internet/browser_visit"

draft = false

toc = true

+++

浏览器访问网址的过程就是客户端（浏览器）和服务端进行数据交换的过程。这个过程大概是：

1. 浏览器将域名转换为IP
2. 浏览器将请求信息打包通过TCP协议进行传输
3. 网络层、数据链路层、物理层之间的数据交换
4. 代理服务器接收请求并转发到后端服务器
5. 后端服务器进行逻辑与数据处理，向代理服务器发送响应数据
6. 代理服务器向客户端发送数据
7. 浏览器收到数据后进行渲染



## 根据域名查找IP（DNS）

为了方便人们记忆，网站往往都会申请一个域名，而网络层使用IP地址作为目的地标识，因为需要将域名转化为IP。查询流程如下：

1. 先查找浏览器的程序内存，如果未找到，执行下一步
2. 查找操作系统缓存，如果未找到，执行下一步
3. 查找本地的host文件，如果未找到，执行下一步
4. 通过域名系统查找，如果未找到，执行下一步
5. 浏览器停止请求并返回错误信息（默认会重试4次）

域名系统是一个层级的分布式系统，最顶层为根域名，每台计算机上都会记录根域名地址。

当计算机在本地找不到域名对应的IP后，会向**本地域名服务器**发起请求。如果**本地域名服务器**也不知道，就会将请求转发到**根域名服务器**。请求会从根域名服务器开始一层一层**向下转发**，直到找到目标域名。找到目标域名后，请求途径的各个服务器都会将其数据放入本地的**缓存**中，以便下次使用。

## 打包数据（HTTP）

浏览器会将请求所需的数据打包，然后提供给操作系统的TCP协议栈。

需要打包的数据往往包括：

1. 请求地址
2. 请求方法
3. 请求体
4. 请求头，请求头内是协议定义的控制信息，如：User-Agent、Host、Accept、Accept-Encoding等

这些数据会按照应用层协议（HTTP）进行组装、编码，然后将数据包提供给操作系统的TCP协议栈，由TCP协议栈进一步处理，并由其负责数据传输。

## 建立套接字（socket）

**套接字是连接应用程序与网络协议栈的接口**，服务端与客户端通过两端的套接字形成了一条连接，两端的数据通过这条连接进行传输。

客户端在发起请求时建立套接字，但服务端必须在客户端发起请求前建立好套接字。

**套接字是一块存放控制信息的内存空间**，这些控制信息包括：IP地址、端口号、状态等。

服务端在创建后，就会创建套接字来监听、等待客户端的连接请求。客户端在发起请求时也会先创建套接字，然后通过套接字发起请求。

## TCP协议栈

TCP协议栈在收到发送数据请求后，会根据套接字的状态信息判断当前连接的状态。

如果当前未建立连接，则会先进行“三次握手”。

如果已建立连接，则会将应用层的数据放到“发送缓冲区”，TCP协议栈会根据当前的网络状态（**拥塞控制**）、服务端的通告窗口（**滑动窗口**）、数据包的大小（是否超过**MSS**）、系统设置（是否开启**Nagle算法**）等来判断在何时发送。

## 数据链路层与网络层

### 适配器（网卡）

适配器是计算机中负责与局域网通信的接口。

当适配器收到有差错的帧时，就把这个帧直接丢弃而不必通知计算机。当适配器收到正确的帧时，它就使用中断来通知该计算机，并交付协议栈中的网络层。

当计算机要发送IP数据报时，就由协议栈把IP数据报向下交给适配器，组装成帧后发送到局域网。

### 路由器

路由器的作用是找到目的主机。路由器内部会维持一张路由表，通过这张路由表可以找到下一跳要访问的路由器。

访问步骤如下：

1. 从数据报的首部提取目的主机的IP地址，从而获得网络地址
2. 如果网络地址就是此路由器直接相连的某个网络地址，则将数据报直接交付给目的主机；否则执行下一步
3. 如果路由表中有到达目的主机的IP地址的特定路由，则将数据报传送给路由表中指定的特定路由；否则执行下一步
4. 若果路由表中有到达目的主机的网络地址的路由，则将数据包传送给路由表中对应的下一跳路由器；否则执行下一步
5. 如果路由表中有一个默认路由，则把数据报传送给默认路由器；否则报告转发分组出错。

由此可见，数据报需要在路由器中一次次转发，直到目的路由器。目的路由器会将数据报发给目的主机。

当路由器收到一个待转发的数据报后，会从路由表中找到下一条路由器的IP地址，然后通过ARP协议（会先查找本地ARP缓存）找到其对应的MAC地址，并将MAC地址放到链路层MAC帧的首部，然后根据这个硬件地址找到下一个路由器。

企业内为了方便管理网络，往往会划分**子网**，此时路由器的转发规则为：

1. 从数据报的首部提取目的主机的IP地址，从而获得网络地址
2. 判断是否为直接交付：对路由器直接相连的网络逐个进行检查，用各网络的子网掩码和目的主机的网络地址逐位相与，如果相应的网络地址和结果匹配，那么就直接进行交付；否则执行下一步
3. 如果路由表中有到达目的主机的IP地址的特定路由，则将数据报传送给路由表中指定的特定路由；否则执行下一步
4. 对路由器中的每一行（目的网络地址、子网掩码、下一跳地址），用其中的子网掩码和目的主机的网络地址逐位相与，如果结果和该行的目的网络地址匹配，则把数据报传送给路由表中对应的下一跳路由器；否则执行下一步
5. 如果路由表中有一个默认路由，则把数据报传送给默认路由器；否则报告转发分组出错。

### 交换机

通过路由器找到了目的主机的MAC地址，还需要通过交换机使用MAC地址找到目的主机。

交换机在内部维持了一张MAC地址表，通过这张表来将数据包传送到目的端口。

## 服务端

### 代理服务器

后端服务器的流量往往由代理服务器（如NGINX）进行代理，其优点是能够高效、稳定的处理并发请求。

代理服务器负责将流量分发到后端节点，在并发量特别大的情况下，还会在代理服务器之前通过负载均衡器进一步分发流量。

### 后端服务

后端服务接收到请求后，解析出请求信息，并进行对应的处理。

在HTTP协议中，通过**请求方法**和**路径**来标识一种请求（通过**trie树**来快速匹配路径）。

后端服务对请求进行逻辑和数据处理中，往往会使用大量的**中间件**（Mysql、Redis、Kafka等）。

处理完后，按照“约定”组装数据，并通过反向代理服务器返回结果。

