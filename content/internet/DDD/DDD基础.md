+++

date = 2021-01-29T23:07:51+08:00
title = "DDD基础"
url = "/internet/ddd/base"

+++



**中台面临的问题**：作为中台，需要**将通用的可复用的业务能力沉淀到中台业务模型**，**实现企业级能力复用**。因此中台面临的首要问题就是中台领域模型的重构。而中台落地时，依然会面临**微服务设计**和**拆分**的问题。





#### 基础

组织架构演进

![](https://static001.geekbang.org/resource/image/8a/f8/8a859915250ffcab04675fb02fdf34f8.jpg)

### DDD解决的问题

DDD **核心思想**是**通过领域驱动设计方法定义领域模型**，从而**确定业务和应用边界**，**保证业务模型与代码模型的一致性**。

**DDD 强调领域模型和微服务设计的一体性**，先有领域模型然后才有微服务，而不是脱离领域模型来谈微服务设计。

其次，就是通过战略设计，建立领域模型，划分微服务边界。

最后，通过战术设计，我们会从领域模型转向微服务设计和落地。

### 战略设计

战略设计主要从业务视角出发，建立业务领域模型，划分领域边界，建立通用语言的限界上下文，限界上下文可以作为微服务设计的参考边界。

<img src="https://static001.geekbang.org/resource/image/3b/73/3bb8915fd6e880d64e9029a1f8677473.jpg" style="zoom:67%;" />

#### 三步来划定领域模型和微服务的边界

1. 在**事件风暴**中**梳理业务过程中的用户操作、事件以及外部依赖关系**等，根据这些要素梳理出**领域实体等领域对象。**
2. 根据**领域实体之间的业务关联性**，将**业务紧密相关的实体进行组合形成聚合，同时确定聚合中的聚合根、值对象和实体**。在这个图里，聚合之间的边界是第一层边界，它们在同一个微服务实例中运行，这个边界是逻辑边界，所以用虚线表示。
3. **根据业务及语义边界等因素，将一个或者多个聚合划定在一个限界上下文内，形成领域模型**。在这个图里，限界上下文之间的边界是第二层边界，这一层边界可能就是**未来微服务的边界**，不同限界上下文内的领域逻辑被隔离在不同的微服务实例中运行，物理上相互隔离，所以是物理边界，**边界之间用实线来表示**。

### 战术设计

战术设计则**从技术视角出发**，**侧重于领域模型的技术实现**，完成软件开发和落地，包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现。

#### 基本概念

- **头脑风暴**: DDD 领域建模通常采用事件风暴，它通常采用**用例分析**、**场景分析**和**用户旅程分析**等方法，通过头脑风暴**列出所有可能的业务行为和事件**，然后**找出产生这些行为的领域对象**，并**梳理领域对象之间的关系**，找出**聚合根**，找出与聚合根业务紧密关联的**实体**和**值对象**，再将聚合根、实体和值对象组合，构建**聚合**。

- **领域**：在研究和解决业务问题时，DDD 会按照一定的规则将业务领域进行细分，当领域细分到一定的程度后，DDD 会将问题范围限定在特定的边界内，在这个边界内建立领域模型，进而用代码实现该领域模型，解决相应的业务问题。简言之，**DDD 的领域就是这个边界内要解决的业务问题域**。

- **子领域**：我们把划分出来的多个子领域称为子域，**每个子域对应一个更小的问题域或更小的业务范围**。

- **核心域**：决定产品和公司**核心竞争力的子域**是核心域，它是业务成功的主要因素和公司的核心竞争力。

- **通用域**：没有太多个性化的诉求，同时**被多个子域使用的通用功能子域**是通用域。

- **支撑域**：既不包含决定产品和公司核心竞争力的功能，也不包含通用功能的功能子域。

- **通用语言**：在事件风暴过程中，通过团队交流达成共识的，能够简单、清晰、准确描述业务涵义和规则的语言就是通用语言。

  > 通用语言包含术语和用例场景，并且能够直接反映在代码中。通用语言中的名词可以给领域对象命名，如商品、订单等，对应实体对象；而动词则表示一个动作或事件，如商品已下单、订单已付款等，对应领域事件或者命令。

- **上下文边界**：用来确定语义所在的**领域边界**。**一个上下文边界理论上就可以设计为一个微服务**。

- **实体**：在 DDD 中有这样一类对象，它们**拥有唯一标识符**，且**标识符在历经各种状态变更后仍能保持一致**。对这些对象而言，重要的不是其属性，而是其延续性和标识，对象的延续性和标识会跨越甚至超出软件的生命周期。我们把这样的对象称为实体。

- **值对象**：通过**对象属性值来识别的对象**，它将多个相关属性组合为一个概念整体。在 DDD 中用来描述领域的特定方面，并且是一个没有标识符的对象，叫作值对象。在领域建模的过程中，值对象可以**保证属性归类的清晰和概念的完整性，避免属性零碎**。将“省、市、县和街道等属性”拿出来构成一个“地址属性集合”，这个集合就是值对象了

- **聚合**：聚合就是**由业务和逻辑紧密关联的实体和值对象组合而成**的，聚合是数据修改和持久化的基本单元，**每一个聚合对应一个仓储，实现数据的持久化**。

- **聚合根**：聚合根的主要目的是**为了避免由于复杂数据模型缺少统一的业务规则控制，而导致聚合、实体之间数据不一致性的问题**。

  > 如果把聚合比作组织，那聚合根就是这个组织的负责人。聚合根也称为根实体，它不仅是实体，还是聚合的管理者。
  >
  > 首先它作为实体本身，拥有实体的属性和业务行为，实现自身的业务逻辑。
  >
  > 其次它作为聚合的管理者，在聚合内部负责协调实体和值对象按照固定的业务规则协同完成共同的业务逻辑。
  >
  > 最后在聚合之间，它还是聚合对外的接口人，以聚合根 ID 关联的方式接受外部任务和请求，在上下文内实现聚合之间的业务协同。也就是说，聚合之间通过聚合根 ID 关联引用，如果需要访问其它聚合的实体，就要先访问聚合根，再导航到聚合内部实体，外部对象不能直接访问聚合内实体。

  ![](https://static001.geekbang.org/resource/image/ac/26/ac0b9db12b201f24c7b2c1e343a88e26.png)

##### 从事件风暴建立通用语言到领域对象设计和代码落地的完整过程。

![](https://static001.geekbang.org/resource/image/69/ee/69f44e120de5019c0fbff4d3fbc0afee.png)

1. 在**事件风暴**的过程中，**领域专家**会和**设计**、**开发人员**一起**建立领域模型**，在领域建模的过程中会形成**通用的业务术语**和**用户故事**。事件风暴也是一个项目团队统一语言的过程。
2. 通过**用户故事分析**会形成一个个的**领域对象**，这些领域对象**对应领域模型的业务对象**，每一个业务对象和领域对象都有通用的名词术语，并且一一映射。
3. **微服务代码模型来源于领域模型**，每个代码模型的代码对象跟领域对象一一对应。



##### 类比桃树

第一步：**确定研究对象**，即研究领域，这里是**一棵桃树**。

第二步：**对研究对象进行细分**，将桃树细分为**器官**，器官又分为**营养器官**和**生殖器官**两种。其中营养器官包括根、茎和叶，生殖器官包括花、果实和种子。**桃树的知识体系**是我们已经**确定要研究的问题域**，对应 DDD 的领域。**根、茎、叶、花、果实和种子等器官**则是细分后的**问题子域**。这个过程就是 DDD **将领域细分为多个子域**的过程。

第三步：对**器官进行细分**，将器官**细分为组织**。比如，叶子器官可细分为保护组织、营养组织和输导组织等。这个过程就是 DDD **将子域进一步细分为多个子域**的过程。

第四步：**对组织进行细分**，将组织细分为细胞，**细胞**成为我们研究的**最小单元**。细胞之间的细胞壁确定了单元的边界，也确定了**研究的最小边界**。

#### 聚合的一些设计原则

1. **在一致性边界内建模真正的不变条件**。聚合用来封装真正的不变性，而不是简单地将对象组合在一起。聚合内有一套**不变的业务规则**，各实体和值对象按照统一的业务规则运行，实现对象数据的一致性，边界之外的任何东西都与该聚合无关，这就是聚合能实现**业务高内聚**的原因。
2. **设计小聚合**。如果聚合设计得过大，聚合会因为包含过多的实体，导致实体之间的管理过于复杂，高频操作时会出现并发冲突或者数据库锁，最终导致系统可用性变差。而小聚合设计则可以**降低由于业务过大导致聚合重构的可能性，让领域模型更能适应业务的变化**。
3. **通过唯一标识引用其它聚合**。**聚合之间是通过关联外部聚合根 ID 的方式引用，而不是直接对象引用的方式**。外部聚合的对象放在聚合边界内管理，容易导致聚合的边界不清晰，也会增加聚合之间的耦合度。
4. **在边界之外使用最终一致性**。聚合内数据强一致性，而聚合之间数据最终一致性。在一次事务中，最多只能更改一个聚合的状态。如果一次业务操作涉及多个聚合状态的更改，应采用领域事件的方式异步修改相关的聚合，实现聚合之间的解耦（相关内容会在领域事件部分详解）。
5. **通过应用层实现跨聚合的服务调用**。为实现微服务内聚合之间的解耦，以及未来以聚合为单位的微服务组合和拆分，应避免跨聚合的领域服务调用和跨聚合的数据库表关联。

#### 聚合的特点

**高内聚**、**低耦合**，它是领域模型中最底层的边界，可以**作为拆分微服务的最小单位**，但不建议对微服务过度拆分。但在对性能有极致要求的场景中，聚合可以独立作为一个微服务，以满足版本的高频发布和极致的弹性伸缩能力。

一个微服务可以包含多个聚合，**聚合之间的边界是微服务内天然的逻辑边界**。有了这个逻辑边界，在微服务架构演进时就可以以聚合为单位进行拆分和组合了，微服务的架构演进也就不再是一件难事了。

#### 聚合根的特点

**聚合根是实体**，有实体的特点，**具有全局唯一标识**，**有独立的生命周期**。**一个聚合只有一个聚合根**，聚合根在聚合内**对实体和值对象**采用**直接对象引用**的方式进行**组织和协调**，**聚合根与聚合根之间通过 ID 关联**的方式实现聚合之间的协同。

#### 实体的特点

**有 ID 标识，通过 ID 判断相等性，ID 在聚合内唯一**即可。状态可变，它依附于聚合根，**其生命周期由聚合根管理**。实体一般会持久化，但**与数据库持久化对象不一定是一对一的关系**。实体可以引用聚合内的聚合根、实体和值对象。

####  值对象的特点

**无 ID，不可变，无生命周期，用完即扔**。值对象之间通过属性值判断相等性。它的**核心本质是值**，是一组概念完整的属性组成的集合，用于**描述实体的状态和特征**。值对象尽量只引用值对象。

## 声明

该文章为整理的笔记，内容来自【欧创新】在极客时间开设的专栏【DDD实战课】。有兴趣的读者可以扫描下方二维码前去学习。

![](https://raw.githubusercontent.com/stong1994/images/master/picgo/8e05d23297752527a14993890421a7d.jpg)

## 相关书籍

- 《领域驱动设计：软件核心复杂性应对之道》——埃里克·埃文斯（Eric Evans）
- 《实现领域驱动设计》
- 《微服务架构设计模式》